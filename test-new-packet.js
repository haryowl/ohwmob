const GalileoskyParser = require('./backend/src/services/parser');

// New packet data from the mobile server log
const newPacketData = Buffer.from('01f99510bc04209bb35a68211200300dc973a0ffb6f35e063300000000342f00350740080a41285e42300f450f00460300500b5e51945e520000e22b71a0fffe0c0001000000000002000000000010bb042091b35a68211400300dc973a0ffb6f35e063300000000342f00350740080a41355e42300f450f0046030050125e51a35e520000e22b71a0fffe0c0001000000000002000000000010ba042087b35a68210100300dc973a0ffb6f35e063300000000342f00350740080a41fc5d42270f450f0046030050eb5d51675e520000e22b71a0fffe0c0001000000000002000000000010b904207db35a68210400300dc973a0ffb6f35e063300000000342f00350740080a41ed5d42270f450f0046030050f05d51765e520000e22b71a0fffe0c0001000000000002000000000010b8042073b35a68210a00300bc973a0ffb6f35e063300000000342f00350740080a41ea5d42270f450f0046030050e55d51645e520000e22b71a0fffe0c0001000000000002000000000010b7042069b35a68210e00300dc973a0ffb6f35e063300000000342f00350740080a411d5e42270f450f0046030050115e51a55e520000e22b71a0fffe0c0001000000000002000000000010b604205fb35a68211200300ec973a0ffb6f35e063300000000342f00350740080a412b5e42270f450f0046030050de5d516a5e520000e22b71a0fffe0c0001000000000002000000000010b5042055b35a68211700300ec973a0ffb6f35e063300000000342f00350740080a41e95d42270f450f0046030050e65d51675e520000e22b71a0fffe0c0001000000000002000000000010b404204bb35a68210200300dc973a0ffb6f35e063300000000342f00350740080a41e35d42270f450f0046030050e95d51745e520000e22b71a0fffe0c0001000000000002000000000010b3042041b35a68214703300dc973a0ffb6f35e063300000000342f00350740080a412e5e42270f450f00460300501e5e51a75e520000e22b71a0fffe0c0001000000000002000000000010b204203ab35a68210f00300dc973a0ffb6f35e063300000000342f00350740090a41e75d42270f450f0046030050f35d51795e520000e22b71a0fffe0c0001000000000002000000000010b1042030b35a68211300300dc973a0ffb6f35e063300000000342f00350740090a41ef5d42270f450f0046030050035e51955e520000e22b71a0fffe0c0001000000000002000000000010b0042026b35a68211700300dc973a0ffb6f35e063300000000342f00350740090a41ec5d42270f450f0046030050fa5d51855e520000e22b71a0fffe0c0001000000000002000000000010af04201cb35a68210400300dc973a0ffb6f35e063300000000342f00350740090a41305e42270f450f0046030050fd5d51805e520000e22b71a0fffe0c0001000000000002000000000010ae042012b35a68210400300dc973a0ffb6f35e063300000000342f00350740090a41055e42260f450f0046030050065e518c5e520000e22b71a0fffe0c0001000000000002000000000010ad042008b35a68210700300dc973a0ffb6f35e063300000000342f00350740090a41105e42260f450f00460300500f5e51915e520000e22b71a0fffe0c0001000000000002000000000010ac0420feb25a68210d00300dc973a0ffb6f35e063300000000342f00350740090a41225e42260f450f00460300500a5e51845e520000e22b71a0fffe0c0001000000000002000000000010ab0420f4b25a68211000300dc973a0ffb6f35e063300000000342f00350740090a412c5e42260f450f0046030050ff5d518c5e520000e22b71a0fffe0c0001000000000002000000000010aa0420eab25a68211500300dc973a0ffb6f35e063300000000342f00350740090a41ed5d42260f450f0046030050ea5d51765e520000e22b71a0fffe0c0001000000000002000000000010a90420e0b25a68210000300dc973a0ffb6f35e063300000000342f00350740090a41f75d42260f450f0046030050ed5d516f5e520000e22b71a0fffe0c0001000000000002000000000010a80420d6b25a68210300300ec973a0ffb6f35e063300000000342f00350740090a41ff5d42260f450f0046030050ed5d51765e520000e22b71a0fffe0c0001000000000002000000000010a70420ccb25a68210600300ec973a0ffb6f35e063300000000342f00350740090a41305e42210f450f00460300500e5e51a05e520000e22b71a0fffe0c0001000000000002000000000010a60420c2b25a68210a00300dc973a0ffb6f35e063300000000342f00350740090a41e55d42210f450f0046030050ee5d51745e520000e22b71a0fffe0c0001000000000002000000000010a50420b8b25a68210f00300cc973a0ffb6f35e063300000000342f00350740090a41f45d42210f450f0046030050f35d51765e520000e22b71a0fffe0c0001000000000002000000000010a40420aeb25a68211100300bc973a0ffb6f35e063300000000342f00350a40090a41f15d42210f450f0046030050015e51835e520000e22b71a0fffe0c0001000000000002000000000010a30420a4b25a68211500300cc973a0ffb6f35e063300000000342f00350740090a41275e42210f450f0046030050025e51865e520000e22b71a0fffe0c0001000000000002000000000010a204209ab25a68211700300bc973a0ffb6f35e063300000000342f00350840090a41365e42210f450f0046030050095e51885e520000e22b71a0fffe0c0001000000000002000000000010a1042090b25a68211800300cc973a0ffb6f35e063300000000342f00350840090a41f75d42190f450f0046030050e55d516f5e520000e22b71a0fffe0c0001000000000002000000000010a0042086b25a68210600300cc973a0ffb6f35e063300000000342f00350740090a41fe5d42190f450f0046030050fc5d51935e520000e22b71a0fffe0c00010000000000020000000000109f04207cb25a68210a00300dc973a0ffb6f35e063300000000342f00350840090a41325e42190f450f0046030050215e51b15e520000e22b71a0fffe0c00010000000000020000000000109e042072b25a68211000300cc973a0ffb6f35e063300000000342f00350740090a411a5e42190f450f0046030050c55d51415e520000e22b71a0fffe0c00010000000000020000000000109d042068b25a68211100300dc973a0ffb6f35e063300000000342f00350740090a41f95d42190f450f0046030050225e51a95e520000e22b71a0fffe0c00010000000000020000000000109c04205eb25a68211400300cc973a0ffb6f35e063300000000342f00350740090a41f85d42190f450f0046030050ef5d51765e520000e22b71a0fffe0c00010000000000020000000000109b042054b25a68211300300cc673a0ffb1f35e063300001e01343000350940090a413a5e421c0f450f0046030050025e517f5e520000e22b71a0fffe0c00010000000000020000000000109a04204ab25a68219500300cc673a0ffb1f35e063326001e01343000350740090a41215e421c0f450f0046030050fa5d516f5e520000e22b71a0fffe0c000100000000000200000000001099042043b25a68210500300ca673a0ff99f35e063300000000342b00350740090a41ea5d421c0f450f0046030050065e51835e520000e22b71a0fffe0c000100000000000200000000001098042039b25a68210900300ca673a0ff99f35e063300000000342b00350740090a41fb5d421c0f450f0046030050e45d516d5e520000e22b71a0fffe0c00010000000000020000000000109704202fb25a68210e00300ca673a0ff99f35e063300000000342b00350740090a41e95d421c0f450f0046030050015e51805e520000e22b71a0fffe0c000100000000000200000000001096042025b25a68211100300ba673a0ff99f35e063300000000342b00350940090a412d5e421c0f450f0046030050095e518a5e520000e22b71a0fffe0c00010000000000020000000000109504201bb25a68211600300aa673a0ff99f35e063300000000342b00350840090a41305e421b0f450f0046030050ee5d51625e520000e22b71a0fffe0c000100000000000200000000001094042011b25a68211000300aa673a0ff99f35e063300000000342b00350840090a41ef5d421b0f450f0046030050f25d51785e520000e22b71a0fffe0c000100000000000200000000001093042007b25a68211500300ca673a0ff99f35e063300000000342b00350740090a41e25d421b0f450f0046030050f95d51855e520000e22b71a0fffe0c0001000000000002000000000010920420fdb15a68210000300ba673a0ff99f35e063300000000342b00350740090a41ec5d421b0f450f0046030050075e51815e520000e22b71a0fffe0c0001000000000002000000000010910420f3b15a68210500300ca673a0ff99f35e063300000000342b00350740090a41df5d421b0f450f0046030050045e51815e520000e22b71a0fffe0c0001000000000002000000000010900420e9b15a68210a00300b9773a0ff6ef35e063300000000342500350740090a41025e421b0f450f0046030050075e51905e520000e22b71a0fffe0c00010000000000020000000000108f0420dfb15a68210e00300c8f73a0ff71f35e063314000000342300350740090a412b5e421b0f450f0046030050f35d51795e520000e22b71a0fffe0c00010000000000020000000000108e0420d5b15a68211100300b6073a0ff3cf35e063300000000342000350740090a41f55d42160f450f0046030050e75d51645e520000e22b71a0fffe0c00010000000000020000000000108d0420cbb15a68211400300b6073a0ff3cf35e063300000000342000350740090a41f35d42160f450f0046030050d25d514e5e520000e22b71a0fffe0c00010000000000020000000000108c0420c1b15a68211700300d6073a0ff3cf35e063300000000342000350740090a41f45d42160f450f0046030050f65d517d5e520000e22b71a0fffe0c00010000000000020000000000108b0420b7b15a68210400300d6073a0ff3cf35e063300000000342000350740090a412b5e42160f450f0046030050015e518d5e520000e22b71a0fffe0c00010000000000020000000000108a0420adb15a68210800300c6073a0ff3cf35e063300000000342000350740090a41345e42160f450f00460300500b5e518d5e520000e22b71a0fffe0c0001000000000002000000000010890420a3b15a68210d00300c6073a0ff3cf35e063300000000342000350740090a41045e42160f450f0046030050ef5d51785e520000e22b71a0fffe0c000100000000000200000000001088042099b15a68211000300d6073a0ff3cf35e063300000000342000350740090a41f05d42110f450f0046030050fa5d517e5e520000e22b71a0fffe0c00010000000000020000000000108704208fb15a68211200300c6073a0ff3cf35e063300000000342000350740090a41fe5d42110f450f0046030050fe5d51835e520000e22b71a0fffe0c000100000000000200000000001086042085b15a68211700300c6073a0ff3cf35e063300000000342000350740090a41215e42110f450f0046030050095e51955e520000e22b71a0fffe0c00010000000000020000000000108504207bb15a68210200300d6073a0ff3cf35e063300000000342000350740090a41135e42110f450f0046030050095e51945e520000e22b71a0fffe0c000100000000000200000000001084042071b15a68210400300d6073a0ff3cf35e063300000000342000350740090a412f5e42110f450f0046030050065e518d5e520000e22b71a0fffe0c000100000000000200000000001083042067b15a68210800300b6073a0ff3cf35e063300000000342000350840090a41fe5d42110f450f00460300500e5e51955e520000e22b71a0fffe0c00010000000000020000000000108204205db15a68210e00300b6073a0ff3cf35e063300000000342000350940090a41f05d420e0f450f0046030050f95d517d5e520000e22b71a0fffe0c000100000000000200000000001081042053b15a68211600300a6073a0ff3cf35e063300000000342000350940090a41f15d420e0f450f0046030050e25d516e5e520000e22b71a0fffe0c000100000000000200000000001080042049b15a68210000300b6073a0ff3cf35e063300000000342000350840090a41f15d420e0f450f0046030050eb5d516f5e520000e22b71a0fffe0c00010000000000020000000000107f04203fb15a68210200300a6073a0ff3cf35e063300000000342000350b40090a41245e420e0f450f0046030050025e518d5e520000e22b71a0fffe0c00010000000000020000000000107e042035b15a6821070030096073a0ff3cf35e063300000000342000350940090a41325e420e0f450f0046030050fe5d517e5e520000e22b71a0fffe0c00010000000000020000000000107d04202bb15a68210c00300c6073a0ff3cf35e063316000000342000350840090a41335e420e0f450f0046030050095e51925e520000e22b71a0fffe0c00010000000000020000000000107c042021b15a68211200300a8273a0ff21f35e063300000000341b00350840090a41f25d420f0f450f0046030050fb5d51825e520000e22b71a0fffe0c00010000000000020000000000107b042017b15a6821110030099173a0ff34f35e063300000000341f00350940090a41de5d420f0f450f0046030050105e51975e520000e22b71a0fffe0c00010000000000020000000000107a04200db15a6821190030098f73a0ff4bf35e063300000000342100350940090a41e45d420f0f450f00460300509a5d511d5e520000e22b71a0fffe0c000100000000000200000000001079042003b15a68210200300b8f73a0ff4bf35e063300000000342100350940090a41f65d420f0f450f0046030050ef5d516c5e520000e22b71a0fffe0c0001000000000002000000000010780420f9b05a6821050030087673a0ff2bf35e063300000000341e00350a40090a41295e420f0f450f0046030050075e51945e520000e22b71a0fffe0c0001000000000002000000000010770420efb05a68210a00300a7673a0ff2bf35e063300000000341e00350a40090a41355e420f0f450f0046030050055e51885e520000e22b71a0fffe0c0001000000000002000000000010760420e5b05a68210e00300b7673a0ff2bf35e063300000000341e00350940090a41ed5d420d0f450f0046030050f75d51735e520000e22b71a0fffe0c0001000000000002000000000010750420dbb05a68216e03300c6073a0ff2bf35e06334f00d90b341d00350840090a412f5e420d0f450f0046030050045e51925e520000e22b71a0fffe0c0001000000000002000000000010740420d9b05a68211700300c5f73a0ff57f35e063300000000341d00350840090a41e95d420d0f450f0046030050015e51895e520000e22b71a0fffe0c0001000000000002000000000010730420cfb05a68210100300d7473a0ff71f35e063300000000341c00350740090a41275e420d0f450f0046030050085e51945e520000e22b71a0fffe0c0001000000000002000000000010720420c5b05a68210700300c8d73a0ff78f35e063300000000341d00350740090a41fd5d420d0f450f0046030050f75d51835e520000e22b71a0fffe0c000100000000000200000000002f75', 'hex');

console.log('Analyzing new packet data...');
console.log('Packet length:', newPacketData.length);
console.log('Packet header:', `0x${newPacketData[0].toString(16)}`);
console.log('Packet length bytes:', newPacketData.slice(1, 3).toString('hex'));

// Parse the length
const rawLength = newPacketData.readUInt16LE(1);
const hasUnsentData = (rawLength & 0x8000) !== 0;
const actualLength = rawLength & 0x7FFF;

console.log('Raw length:', rawLength);
console.log('Has unsent data:', hasUnsentData);
console.log('Actual length:', actualLength);

// Extract data portion
const dataStart = 3;
const dataEnd = dataStart + actualLength;
const data = newPacketData.slice(dataStart, dataEnd);

console.log('\nData portion (first 100 bytes):', data.slice(0, 100).toString('hex'));

// Analyze the data structure
console.log('\n=== Analyzing Data Structure ===');

// Look for 0x10 tags (record markers) and analyze the structure
let recordCount = 0;
let offset = 0;
const recordOffsets = [];

while (offset < data.length) {
    if (data[offset] === 0x10) {
        recordCount++;
        recordOffsets.push(offset);
        console.log(`Record ${recordCount} starts at offset ${offset}`);
        
        // Show next few bytes after 0x10
        const nextBytes = data.slice(offset, offset + 20);
        console.log(`  Next bytes: ${nextBytes.toString('hex')}`);
        
        // Try to find the next 0x10 tag
        let nextRecordStart = offset + 1;
        while (nextRecordStart < data.length && data[nextRecordStart] !== 0x10) {
            nextRecordStart++;
        }
        
        if (nextRecordStart < data.length) {
            const recordLength = nextRecordStart - offset;
            console.log(`  Record ${recordCount} length: ${recordLength} bytes`);
            
            // Analyze the record structure
            const recordData = data.slice(offset, nextRecordStart);
            console.log(`  Record data: ${recordData.toString('hex')}`);
            
            // Look for valid tags in this record
            let tagOffset = 0;
            const foundTags = [];
            while (tagOffset < recordData.length) {
                const tag = recordData[tagOffset];
                if (tag === 0x10 || tag === 0x20 || tag === 0x21 || tag === 0x30 || 
                    tag === 0x33 || tag === 0x34 || tag === 0x35 || tag === 0x40 || 
                    tag === 0x41 || tag === 0x42 || tag === 0x45 || tag === 0x46 || 
                    tag === 0x50 || tag === 0x51 || tag === 0x52 || tag === 0xe2 || 
                    tag === 0xfe) {
                    foundTags.push(`0x${tag.toString(16)}`);
                }
                tagOffset++;
            }
            console.log(`  Valid tags found: ${foundTags.join(', ')}`);
        }
    }
    offset++;
}

console.log(`\nTotal records found: ${recordCount}`);

// Test with the parser
console.log('\n=== Testing with Parser ===');
const parser = new GalileoskyParser();

async function testNewPacket() {
    try {
        const result = await parser.parse(newPacketData);
        console.log('Parser result:', {
            header: `0x${result.header.toString(16)}`,
            length: result.length,
            hasUnsentData: result.hasUnsentData,
            recordsFound: result.records.length
        });
        
        if (result.records.length > 0) {
            console.log('\nFirst record tags:', Object.keys(result.records[0].tags));
            console.log('\nFirst record archive number:', result.records[0].tags['0x10']);
        }
        
    } catch (error) {
        console.error('Parser error:', error.message);
    }
}

testNewPacket(); 